<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://github.com/accenture/mercury-nodejs/guides/CHAPTER-5/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Chapter-5 - Composable for Node.js</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Chapter-5";
        var mkdocs_page_input_path = "guides/CHAPTER-5.md";
        var mkdocs_page_url = "/accenture/mercury-nodejs/guides/CHAPTER-5/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Composable for Node.js
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../METHODOLOGY/">Methodology</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-1/">Chapter-1</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-2/">Chapter-2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-3/">Chapter-3</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-4/">Chapter-4</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Chapter-5</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#main-application">Main application</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#writing-your-functions">Writing your functions</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#http-forwarding">HTTP forwarding</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sending-http-request-event-to-more-than-one-service">Sending HTTP request event to more than one service</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#writing-a-unit-test">Writing a unit test</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#convenient-utility-classes">Convenient utility classes</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#event-flow-mocking-framework">Event Flow mocking framework</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#deployment">Deployment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#distributed-tracing">Distributed tracing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#npm-alias-for-mercury-composable-core-library">"npm" alias for mercury-composable core library</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-6/">Chapter-6</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../CHAPTER-7/">Chapter-7</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-I/">Appendix-I</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../APPENDIX-II/">Appendix-II</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CHANGELOG/">Release notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../arch-decisions/DESIGN-NOTES/">Design notes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../INCLUSIVITY/">Inclusivity</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CODE_OF_CONDUCT/">Code of Conduct</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING/">Contribution</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../TABLE-OF-CONTENTS/">Contents</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Composable for Node.js</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Chapter-5</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="build-test-and-deploy">Build, Test and Deploy</h1>
<p>The first step in writing an application is to create an entry point for your application.</p>
<h2 id="main-application">Main application</h2>
<p>A minimalist main application template is shown as follows:</p>
<pre><code class="language-shell">async function main() {
    // Load composable functions into memory and initialize configuration management
    ComposableLoader.initialize();
    const platform = Platform.getInstance();
    platform.runForever();
    // wait for platform to load essential services
    await platform.getReady();
    log.info('Composable application started');
}
// run the application
main();
</code></pre>
<p>You can also build and run the application from command line like this:</p>
<pre><code class="language-shell">cd sandbox/mercury-nodejs/examples
npm install
npm run build
</code></pre>
<p>Since all functions are connected using the in-memory event bus, you can test any function by sending events
from a unit test module.</p>
<h2 id="writing-your-functions">Writing your functions</h2>
<p>Please follow the step-by-step learning guide in <a href="../CHAPTER-1/">Chapter-1</a> to write your own functions. You can then
configure new REST endpoints to use your new functions.</p>
<h2 id="http-forwarding">HTTP forwarding</h2>
<p>In <a href="../CHAPTER-3/">Chapter-3</a>, we have presented the configuration syntax for the "rest.yaml" REST automation
definition file. Please review the sample rest.yaml file in the lambda-example project. You may notice that
it has an entry for HTTP forwarding. The following entry in the sample rest.yaml file illustrates an HTTP
forwarding endpoint. In HTTP forwarding, you can replace the "service" route name with a direct HTTP target host.
You can do "URL rewrite" to change the URL path to the target endpoint path. In the below example,
<code>/api/v1/*</code> will be mapped to <code>/api/*</code> in the target endpoint.</p>
<pre><code class="language-yaml">  - service: &quot;http://127.0.0.1:${rest.server.port}&quot;
    trust_all_cert: true
    methods: ['GET', 'PUT', 'POST']
    url: &quot;/api/v1/*&quot;
    url_rewrite: ['/api/v1', '/api']
    timeout: 20
    cors: cors_1
    headers: header_1
    tracing: true
</code></pre>
<h2 id="sending-http-request-event-to-more-than-one-service">Sending HTTP request event to more than one service</h2>
<p>One feature in REST automation "rest.yaml" configuration is that you can configure more than one function in the
"service" section. In the following example, there are two function route names ("hello.world" and "hello.copy").
The first one "hello.world" is the primary service provider. The second one "hello.copy" will receive a copy of
the incoming event.</p>
<p>This feature allows you to write new version of a function without disruption to current functionality. Once you are
happy with the new version of function, you can route the endpoint directly to the new version by updating the
"rest.yaml" configuration file.</p>
<pre><code class="language-yaml">  - service: [&quot;hello.world&quot;, &quot;hello.copy&quot;]
</code></pre>
<h2 id="writing-a-unit-test">Writing a unit test</h2>
<p>In unit test, we want to start the main application so that all the functions are ready for tests.</p>
<p>In the following example, the import statement will start the main application and we verify that the
application is started successfully by reading the base configuration in the <code>BeforeAll</code> method. </p>
<pre><code class="language-javascript">// main application will automatically start when imported
import '../src/composable-example';

describe('End-to-end tests', () =&gt; {

    beforeAll(async () =&gt; {
        const config = AppConfig.getInstance();
        const port = config.get('server.port');
        targetHost = `http://127.0.0.1:${port}`;
        log.info(`Begin end-to-end tests with port ${port}`);
    });

    // your unit test here    
}
</code></pre>
<p>However, if you have more than one set of unit tests starting the same application, the other set of unit tests
must override the "server.port" so that both sets of unit tests can co-exist. Otherwise, the second set of unit
tests cannot start the system with the same server port. The following example illustrates this technique:</p>
<pre><code class="language-javascript">import { ComposableLoader } from '../src/preload/preload';

function getRootFolder() {
    const folder = fileURLToPath(new URL(&quot;..&quot;, import.meta.url));
    // for windows OS, convert backslash to regular slash and drop drive letter from path
    const path = folder.includes('\\')? folder.replaceAll('\\', '/') : folder;
    const colon = path.indexOf(':');
    return colon == 1? path.substring(colon+1) : path;
}

describe('Service tests', () =&gt; {

    beforeAll(async () =&gt; {
        const resourcePath = getRootFolder() + 'src/resources';
        // AppConfig should be initialized with base configuration parameter before everything else
        const appConfig = AppConfig.getInstance(resourcePath);
        // You can programmatically change a configuration parameter.
        // This emulates Java's System.setProperty behavior.
        appConfig.set('server.port', 8303);
        const port = appConfig.getProperty(&quot;server.port&quot;);
        // print out the port number to confirm that it is using a different one.
        const baseUrl = `http://127.0.0.1:${port}`;
        log.info(`Service tests will use ${baseUrl}`);         
        ComposableLoader.initialize();
        platform = Platform.getInstance();
        platform.runForever();
    });

    afterAll(async () =&gt; {
        await platform.stop();
        // give console.log a moment to finish
        await util.sleep(2000);
        log.info(&quot;Service tests completed&quot;);
    });

    it('can do health check', async () =&gt; {
        const po = new PostOffice();
        const req = new EventEnvelope().setTo('demo.health').setHeader('type', 'health');
        const result = await po.request(req, 2000);
        expect(result).toBeTruthy();
        expect(result.getBody()).toEqual({&quot;status&quot;: &quot;demo.service is running fine&quot;});
    });  
}
</code></pre>
<p>In the above example, the "ComposableLoader.initialize()" command tells the system to load the composable functions.</p>
<p>To override the server port, we must initialize the configuration management system first. We resolve the file path
for application.yml and start the AppConfig class by acquiring its singleton instance. We then set the "server.port"
parameter with another port number.</p>
<p>The "can do health check" is a sample unit test that use the PostOffice API to send a request to the "demo.health"
function.</p>
<p>Please refer to the e2e.test.ts and service.test.ts as an example.</p>
<h3 id="convenient-utility-classes">Convenient utility classes</h3>
<p>The Utility and MultiLevelMap classes are convenient tools for unit tests.</p>
<p>The MultiLevelMap supports reading an element using the convenient "dot and bracket" format.</p>
<p>For example, given a map like this:</p>
<pre><code class="language-json">{
  &quot;body&quot;:
  {
    &quot;time&quot;: &quot;2023-03-27T18:10:34.234Z&quot;,
    &quot;hello&quot;: [1, 2, 3]
  }
}
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: center;">Example</th>
<th style="text-align: left;">Command</th>
<th style="text-align: left;">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: left;">map.getElement("body.time")</td>
<td style="text-align: left;">2023-03-27T18:10:34.234Z</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: left;">map.getElement("body.hello[2]")</td>
<td style="text-align: left;">3</td>
</tr>
</tbody>
</table>
<h2 id="event-flow-mocking-framework">Event Flow mocking framework</h2>
<p>We recommend using Event Script to write Composable application for highest level of decoupling.
Event Script supports sophisticated event choreography by configuration.</p>
<p>In Event Script, you have a event flow configuration and a few Composable functions in an application.
Composable functions are self-contained with zero dependencies with other composable functions.
You can invoke an event flow from an event flow adapter.</p>
<p>The most common flow adapter is the "HTTP flow adapter" and it is available as a built-in module in
the event-script-engine module in the system. You can associate many REST endpoints to the HTTP flow
adapter.</p>
<p>Since function routes for each composable function is defined in a event flow configuration and the same
function route may be used for more than one task in the flow, the system provides a mock helper class
called "EventScriptMock" to let your unit tests to override a task's function routes during test.</p>
<p>In the following unit test example for a "pipeline" test, we created a mock function "my.mock.function"
to override the "no.op" function that is associated with the first task "echo.one" in a pipeline.</p>
<p>The original "no.op" function is an echo function. The mocked function increments a counter
in addition to just echoing the input payload. In this fashion, the unit test can count the number
of iteration of a pipeline to validate the looping feature of a pipeline.</p>
<p>The unit test programmatically registers the mock function and override an existing function route with
the new route for the mock function.</p>
<pre><code class="language-javascript">it('can do for-loop in pipeline', async () =&gt; {
    const po = new PostOffice();
    const req1 = new AsyncHttpRequest().setMethod('GET')
                    .setTargetHost(baseUrl).setUrl('/api/for-loop/test-user')
                    .setQueryParameter('seq', '100')
                    .setHeader('accept', 'application/json');
    // the iterationCount will be incremented by &quot;my.mock.function&quot;                                    
    iterationCount = 0;
    var mock = new EventScriptMock(&quot;for-loop-test&quot;);
    var previousRoute = mock.getFunctionRoute('echo.one');
    var currentRoute = mock.assignFunctionRoute('echo.one', 'my.mock.function').getFunctionRoute('echo.one');
    expect(previousRoute).toBe('no.op');
    expect(currentRoute).toBe('my.mock.function');
    const reqEvent = new EventEnvelope().setTo(ASYNC_HTTP_CLIENT).setBody(req1.toMap());
    const result = await po.request(reqEvent);
    expect(result.getStatus()).toBe(200);
    expect(result.getBody() instanceof Object);
    const map = new MultiLevelMap(result.getBody() as object);
    expect(result.getHeader('content-type')).toBe('application/json');
    expect(map.getElement(&quot;data.sequence&quot;)).toBe(100);
    expect(map.getElement(&quot;data.user&quot;)).toBe('test-user');
    expect(map.getElement(&quot;n&quot;)).toBe(3);
    expect(iterationCount).toBe(3);
});
</code></pre>
<p>When the event flow finishes, you will see an "end-of-flow" log like this. It shows that the function
route for the "echo.one" task has been changed to "my.mock.function". This end-of-flow log is useful
during application development and tests so that the developer knows exactly which function has been
executed.</p>
<pre><code class="language-text">Flow for-loop-test (0afcf555fc4141f4a16393422e468dc9) completed. Run 11 tasks in 28 ms. 
[ sequential.one, 
  echo.one(my.mock.function), 
  echo.two(no.op), 
  echo.three(no.op), 
  echo.one(my.mock.function), 
  echo.two(no.op), 
  echo.three(no.op), 
  echo.one(my.mock.function), 
  echo.two(no.op), 
  echo.three(no.op), 
  echo.four(no.op) ]
</code></pre>
<h2 id="deployment">Deployment</h2>
<p>The <code>npm run build</code> command will generate an executable javascript bundle in the "dist" folder.
Your pipeline can deploy the bundle in a Docker instance accordingly.</p>
<p>Composable application is designed to be deployable using Kubernetes or serverless.</p>
<h2 id="distributed-tracing">Distributed tracing</h2>
<p>The system has a built-in distributed tracing feature. You can enable tracing for any REST endpoint by adding
"tracing=true" in the endpoint definition in the "rest.yaml" configuration file.</p>
<p>You may also upload performance metrics from the distributed tracing data to your favorite telemetry system dashboard.</p>
<p>To do that, please implement a custom metrics function with the route name <code>distributed.trace.forwarder</code>.</p>
<p>The input to the function will be a JSON of key-values like this:</p>
<pre><code class="language-shell">trace={path=/api/upload/demo, service=hello.upload, success=true, 
       origin=2023032731e2a5eeae8f4da09f3d9ac6b55fb0a4, 
       exec_time=77.462, start=2023-03-27T19:38:30.061Z, 
       from=http.request, id=12345, round_trip=132.296, status=200}
</code></pre>
<p>The system will detect if <code>distributed.trace.forwarder</code> is available. If yes, it will forward performance metrics
from distributed trace to your custom function.</p>
<h2 id="npm-alias-for-mercury-composable-core-library">"npm" alias for mercury-composable core library</h2>
<p>While you may use github as a repository to test drive your applications, you would need to build and publish the
mercury-composable library to your enterprise "npm" artifactory. Please consult your DevSecOps colleagues for
pipeline setup procedure. It would vary from one organization to another.</p>
<p>If you publish the mercury-composable to your own artifactory as another package name, you would add a "npm alias"
in the package.json of your application like this:</p>
<pre><code class="language-shell">  &quot;scripts&quot;: {
    &quot;clean&quot;: &quot;node clean.js &amp;&amp; node placeholder.js&quot;,
    &quot;pull&quot;: &quot;npm uninstall actual-published-package-name &amp;&amp; npm install actual-published-package-name&quot;,
    &quot;preload&quot;: &quot;node preloader.js&quot;,
    &quot;prebuild&quot;: &quot;npm run lint&quot;,
    &quot;build&quot;: &quot;npm run preload &amp;&amp; tsc -p tsconfig.json &amp;&amp; node copy-resource-files.js&quot;,
    &quot;build:watch&quot;: &quot;tsc -w -p tsconfig.json&quot;,
    &quot;lint&quot;: &quot;eslint . --fix&quot;,
    &quot;test&quot;: &quot;node --experimental-vm-modules node_modules/jest/bin/jest.js --detectOpenHandles&quot;,
    &quot;test:watch&quot;: &quot;jest --watch&quot;
  },
  &quot;dependencies&quot;: {
    &quot;actual-published-package-name&quot;: &quot;^4.2.15&quot;,
    &quot;mercury-composable&quot;: &quot;npm:actual-published-package-name&quot;
  }
</code></pre>
<p>In the above example, it assumes the actual package name that is published from mercury-composable core library
is "actual-published-package-name", the package name "mercury-composable" becomes an alias so that you can keep
the import statements that point to "mercury-composable" unchanged.</p>
<p>You would need to update "scripts.pull" command and the "dependencies" section accordingly.
The "scripts.pull" command is used to pull the latest code from your enterprise artifactory and the
"mercury-composable" entry in the "dependencies" section is an alias to your published package.</p>
<p>Once you have updated the package.json file in the "examples" folder, you may run "npm run build". This verifies
that the example application can import from the newly published mercury-composable core library in your own
artifactory.
<br/></p>
<table>
<thead>
<tr>
<th style="text-align: center;">Chapter-4</th>
<th style="text-align: center;">Home</th>
<th style="text-align: center;">Chapter-6</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;"><a href="../CHAPTER-4/">Event Script Syntax</a></td>
<td style="text-align: center;"><a href="../TABLE-OF-CONTENTS/">Table of Contents</a></td>
<td style="text-align: center;"><a href="../CHAPTER-6/">Event over HTTP</a></td>
</tr>
</tbody>
</table>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../CHAPTER-4/" class="btn btn-neutral float-left" title="Chapter-4"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../CHAPTER-6/" class="btn btn-neutral float-right" title="Chapter-6">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../CHAPTER-4/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../CHAPTER-6/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
